#!/usr/bin/env bpftrace

BEGIN
{
  printf("Tracing TCP send latency... Hit Ctrl-C to stop.\n");
}

kprobe:tcp_sendmsg
{
  @start[tid] = nsecs;
}

kretprobe:tcp_sendmsg
/@start[tid]/
{
  $delta = (nsecs - @start[tid]) / 1000;
  @latency_us = hist($delta);
  delete(@start[tid]);
}
